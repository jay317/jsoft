<?php
defined('BASEPATH') OR exit('No direct script access allowed');


class Optics extends CI_Controller {

	public function __construct() {

		parent::__construct();
		if(!$this->session->userdata("username"))
		{
			redirect('welcome/index');
		}
		$this->load->model('OpticsModel');

	}

	/*-----------  order  --------*/
function index(){
	redirect('optics/order');
} 	
function orderList(){
	if($this->input->get('list_type')){
		$list_type=$_REQUEST['list_type'];
		$data['list_type']=$list_type;
		$data['orderList']=$this->OpticsModel->optOrderListGet();
		$data['page_title']='Orders List';
		$data['req_page_name']="optics/order_list";
		$this->load->view('layout',$data);
	}else{
		if($_SESSION['usertype']=='user'){
			$data['list_type']='lab';
			$data['orderList']=$this->OpticsModel->optOrderListGet();
			$data['page_title']='Orders List';
			$data['req_page_name']="optics/order_list";
			$this->load->view('layout',$data);
		}else{
			$data['list_type']='shop';
			$data['orderList']=$this->OpticsModel->optOrderListGet();
			$data['page_title']='Orders List';
			$data['req_page_name']="optics/order_list";
			$this->load->view('layout',$data);
		}
	}
	}
	
	public function order(){
		$last_order_no  =$this->db->select('icw_opt_orderNo_0317')->order_by('icw_opt_orderNo_0317','desc')->limit(1)->get('icw_opt_order_0317')->row('icw_opt_orderNo_0317');
		if($last_order_no ==0){
			$last_order_no=1;
		}else{
			$last_order_no=$last_order_no + 1;
		}
		$data['order_no']=$last_order_no;
		$data['page_title']='Place order';
		$data['req_page_name']='optics/optical-order';
		$this->load->view('layout',$data);
	}

	public function optOrderSave(){
		$newdate = date('Y-m-d', strtotime($_POST['date']));
		$settingDetails=$this->session->userdata('settingDetails');
		$last_order_no=trim($_POST['orderNo']);
		$ordData= array(
		'shopId'=>$settingDetails->icw_shopId0317,
		'date'=>$newdate,
		'cusName'=>trim($_POST['cusName']),	
		'mobile'=>trim($_POST['mobile']),
		'frame'=>trim($_POST['frame']),
		'lenses'=>trim($_POST['lenses']),
		'totalAmount'=>trim($_POST['totalAmount']),
		'advnc'=>trim($_POST['advnc']),
		'balance'=>trim($_POST['balance']),
		'orderNo'=>trim($_POST['orderNo']),
		'rdSph'=>trim($_POST['rdSph']),
		'rdCyl'=>trim($_POST['rdCyl']),
		'rdAxis'=>trim($_POST['rdAxis']),
		'rnSph'=>trim($_POST['rnSph']),
		'rnCyl'=>trim($_POST['rnCyl']),
		'rnAxis'=>trim($_POST['rnAxis']),
		'ldSph'=>trim($_POST['ldSph']),
		'ldCyl'=>trim($_POST['ldCyl']),
		'ldAxis'=>trim($_POST['ldAxis']),
		'lnSph'=>trim($_POST['lnSph']),
		'lnCyl'=>trim($_POST['lnCyl']),
		'lnAxis'=>trim($_POST['lnAxis'])	
		);//print_r($_REQUEST);die;
		//echo $_POST['lnAxis']; die;
		$res=$this->OpticsModel->optOrderSave($ordData);
		if($res==true){
			$res=$this->OpticsModel->optOrderGet($last_order_no);
			if($res){
				$settingDetails=$this->session->userdata('settingDetails');
				$mobile=$_POST['mobile'];
				$shopType=$settingDetails->icw_shop_type0317;
				$this->load->model('SendSms');
				$this->load->model('MainModel');
				$getTemp=$this->OpticsModel->getTemplates($shopType);
				//print_r($getTemp->icw_id0317);die;
				$tmplt_id=1;
				$custSms=$this->SendSms->send_sms($mobile,$tmplt_id);
				//$techniSms=$this->SendSms->send_sms($mobile,$tmplt_id);
				//$send=$sms->send_sms;
				$data['rslt']=$res;
				$data['page_title']='Order Form Receipt';
				$data['req_page_name']="optics/order_receipt";
				$this->load->view('layout',$data);
			}
		}else{
			return false;
		}

	}
	
	function orderComplete(){
		$invo_print=$_REQUEST['print'];
		$last_order_no=$_REQUEST['ord_no'];
		if($invo_print =='invoice'){
			$paid=$this->OpticsModel->optOrderPaid($last_order_no);
			$res=$this->OpticsModel->optOrderGet($last_order_no);
			$data['rslt']=$res;
			$data['page_title']='Invoice';
			$data['req_page_name']="optics/order_invoice";
			$this->load->view('layout',$data);
		}elseif($invo_print =='ord_check'){
			$res=$this->OpticsModel->optOrderGet($last_order_no);
			$data['rslt']=$res;
			$data['page_title']='Order Check';
			$data['req_page_name']="optics/order_lab";
			$this->load->view('layout',$data);
		}else{
			$res=$this->OpticsModel->optOrderGet($last_order_no);
			$data['rslt']=$res;
			$data['page_title']='Invoice';
			$data['req_page_name']="optics/order_complete";
			$this->load->view('layout',$data);
		}
	}

	function orderDispatch(){
		$last_order_no=$_REQUEST['ord_no'];
		$result=$this->OpticsModel->orderDispatch($last_order_no);
		if($result==true){
			$res=$this->OpticsModel->optOrderGet($last_order_no);
			$data['list_type']="lab";
			$data['rslt']=$res;
			$data['page_title']='Order Check';
			$data['orderList']=$this->OpticsModel->optOrderListGet();
			$data['req_page_name']="optics/order_list";
			$this->load->view('layout',$data);
		}else{}
	}

	function delete_Order(){
		$del_id=$_REQUEST['del_id'];
		$result=$this->OpticsModel->orderDelete($del_id);
		if($result==TRUE){
			$data['list_type']='shop';
			$data['orderList']=$this->OpticsModel->optOrderListGet();
			$data['page_title']='Orders List';
			$data['req_page_name']="optics/order_list";
			$this->load->view('layout',$data);
		}else{}
	}

}
?>